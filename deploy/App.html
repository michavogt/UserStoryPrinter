<!DOCTYPE html>
<html>
<head>
    <title>UserStoryPrinter</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",requires:["Rally.data.wsapi.Store","Rally.app.plugin.Print"],plugins:[{ptype:"rallyappprinting"}],componentCls:"printcards",items:[{xtype:"container",itemId:"pulldown-container",layout:{type:"vbox",align:"stretch"}},{xtype:"container",itemId:"textfield-container",layout:{type:"hbox",align:"stretch"}},{xtype:"container",itemId:"button-container"}],selectedRelease:void 0,featureStore:void 0,featureComboBox:void 0,storyStore:void 0,selectedFeature:void 0,storyGrid:void 0,storyNameFilterTextField:void 0,setFilterButton:void 0,launch:function(){var e=this,t={xtype:"rallyreleasecombobox",itemId:"release-combobox",maxWidth:400,fieldLabel:"Release",labelAlign:"right",listeners:{ready:function(t){console.log("releaseCombox event ready: -> _loadFeatures"),e._loadFeatures(t.getRecord())},select:function(t){console.log("releaseCombox event select: -> _loadFeatures"),e._loadFeatures(t.getRecord())},scope:e}};e.down("#pulldown-container").add(t),console.log("added release-combobox")},_loadFeatures:function(e){var t=this;if(console.log("_loadFeatures entered"),t.selectedRelease=e,console.log("selected release",e.data.Name),t.featureStore)return console.log("featureStore exists, just load new data"),t.featureStore.setFilter(t._getReleaseFilter(e.data.Name)),void t.featureStore.load();console.log("new featureStore created"),t.featureStore=Ext.create("Rally.data.wsapi.Store",{xtype:"rallywsapidatastore",model:"PortfolioItem/Feature",autoLoad:!0,context:{project:"/project/7048691823",projectScopeUp:!1,projectScopeDown:!0},filters:t._getReleaseFilter(e.data.Name),listeners:{load:function(e){console.log("featureStore event loaded: -> _selectFeature"),t._selectFeature(e)},scope:t},fetch:["FormattedID","Name","UserStories","Release"]})},_selectFeature:function(e){var t=this;console.log("_selectFeature entered"),t.featureComboBox?console.log("featureCombobox exists"):(t.featureComboBox=Ext.create("Rally.ui.combobox.ComboBox",{xtype:"rallycombobox",itemId:"feature-combobox",maxWidth:400,fieldLabel:"Feature",labelAlign:"right",store:e,displayField:"FormattedID",listeners:{ready:function(e){console.log("featureCombobox event ready: -> _loadStories"),t.selectedFeature=e.getRecord(),t._loadStories(t.selectedFeature)},select:function(e){console.log("featureCombox event select: -> _loadStories"),t.selectedFeature=e.getRecord(),t._loadStories(t.selectedFeature)},scope:t}}),t.down("#pulldown-container").add(t.featureComboBox),console.log("added feature-combobox"),t.storyNameFilterTextField=Ext.create("Rally.ui.TextField",{xtype:"rallytextfield",itemId:"storyNameFilter-TextField",width:400,fieldLabel:"US Name contains:"}),t.down("#textfield-container").add(t.storyNameFilterTextField),console.log("added storyNameFilter-TextField"),t.setFilterButton={xtype:"rallybutton",itemId:"setfilter-button",text:"Apply US Filter",region:"center",handler:function(){console.log("store data",t.storyStore.data),console.log("checkboxes",t.storyGridSelectionCheckBoxes),t.down("#button-container").setLoading("Please wait..."),Ext.Function.defer(function(){!function(e){for(var o=t.storyNameFilterTextField.getValue().toUpperCase(),r=t.storyStore.data.items.length,a=0;a<r;a++)t.storyStore.data.items[a].data.Name.toUpperCase().indexOf(o)<0&&t.storyGridSelectionCheckBoxes.isSelected(a)&&t.storyGridSelectionCheckBoxes.deselect(a,!0);e&&e()}(function(){t.down("#button-container").setLoading(!1)})},10)},scope:t},t.down("#button-container").add(t.setFilterButton),console.log("added setfilter-button"),t.printButton={xtype:"rallybutton",itemId:"print-button",text:"Generate Story Cards",region:"center",handler:function(){t._printCards()},scope:t},t.down("#button-container").add(t.printButton),console.log("added print-button"))},_loadStories:function(e){var t=this;if(console.log("_loadStories entered"),t.selectedFeature=e,console.log("selected feature",e.data.FormattedID),t.storyStore)return console.log("storyStore exists, just load new data"),t.storyStore.setFilter(t._getFeatureFilter(e.data.FormattedID)),void t.storyStore.load();console.log("new storyStore created"),t.storyStore=Ext.create("Rally.data.wsapi.Store",{model:"User Story",autoLoad:!0,pageSize:1e3,filters:t._getFeatureFilter(e.data.FormattedID),context:{project:"/project/7048691823",projectScopeUp:!1,projectScopeDown:!0},listeners:{load:function(e){console.log("storyStore event load: (does nothing if storyGrid exists)"),t.storyGrid||t._createGrid(e)},scope:t},fetch:["FormattedID","Feature","Project","Name","Owner","Description","PlanEstimate"]})},_createGrid:function(e){var t=this;t.storyGridSelectionCheckBoxes=Ext.create("Ext.selection.CheckboxModel",{injectCheckbox:1,allowDeselect:!0,pruneRemoved:!0,mode:"MULTI"}),t.storyGrid={xtype:"rallygrid",itemId:"story-grid",id:"grid",store:e,selModel:t.storyGridSelectionCheckBoxes,columnCfgs:["FormattedID","Name","Owner"],listeners:{boxready:function(){console.log("storyGrid boxready: event"),t.storyGridSelectionCheckBoxes.selectAll()},load:function(){console.log("storyGrid load: event"),t.storyGridSelectionCheckBoxes.selectAll()},scope:t}},t.add(t.storyGrid)},_getReleaseFilter:function(e){return Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",operator:"=",value:e})},_getFeatureFilter:function(e){return Ext.create("Rally.data.wsapi.Filter",{property:"Feature.FormattedID",operator:"=",value:e})},getOptions:function(){return[this.getPrintMenuOption({title:"Print Story Cards App"})]},_printCards:function(){var e=this;if(0!==e.storyGridSelectionCheckBoxes.selected.length){e.removeAll();var t="";console.log("_printCards entered"),e.add({xtype:"container",itemId:"cards"}),e.down("#cards").getEl().setHTML(""),_.each(e.storyGridSelectionCheckBoxes.selected.items,function(e,o){t+=Ext.create("Rally.apps.printcards.PrintCard").tpl.apply(e.data),o%4==3&&(t+='<div class="pb"></div>')},e),Ext.DomHelper.insertHtml("beforeEnd",e.down("#cards").getEl().dom,t),Rally.BrowserTest&&Rally.BrowserTest.publishComponentReady(e)}else Rally.ui.notify.Notifier.showWarning({message:"No stories to print"})}});
                !function(){var t=window.Ext4||window.Ext;t.define("Rally.apps.printcards.PrintCard",{extend:"Ext.Component",alias:"widget.printcard",tpl:t.create("Ext.XTemplate",'<tpl><div class="artifact"><span class="featureFormattedid">{Feature.FormattedID}</span><span class="planestimate">{[this.getEstimate(values)]}</span></br><span class="featureName">{Feature.Name}</span><div class="content"><div class="storyName">{Name}</div></div><span class="usandproject">{[this.getUsAndProject(values)]}</span></div></tpl>',{getEstimate:function(t){return t.Estimate||t.PlanEstimate||"None"},getUsAndProject:function(t){return t.FormattedID+"</br>"+t.Project.Name},getUs:function(t){return t.FormattedID},getProject:function(t){return t.Project.Name}})})}();

            Rally.launchApp('CustomApp', {
                name:"UserStoryPrinter",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
    <style type="text/css">
        .printcards{margin:5px;width:100%;height:100%}.printcards html{background-color:#fff;color:#000;font:13pt / 1.26;margin:0;padding:0}.printcards .header{margin:5px}.printcards .storyName{font:18pt NotoSans, Helvetica, Arial;font-weight:bold;margin:0.25em auto 0 auto;padding-top:1.5em;text-align:center;padding-left:1.0em;padding-right:1.0em;overflow-y:hidden;width:100%;word-wrap:break-word}.printcards .featureFormattedid{float:left;font:18pt / 1.26 NotoSans,Helvetica,Arial;font-weight:bold;margin-left:0.25em;margin-top:0.3em}.printcards .usandproject{float:left;font:18pt / 1.26 NotoSans,Helvetica,Arial;font-weight:bold;margin-left:0.25em}.printcards .us{float:left;font:18pt / 1.26 NotoSans,Helvetica,Arial;margin-left:0.25em}.printcards .project{float:left;font:13pt / 1.26 NotoSans,Helvetica,Arial;margin-left:0.25em}.printcards .featureName{float:left;font:10pt / 1.26 NotoSans,Helvetica,Arial;margin-left:0.25em;margin-top:0.3em;height:21px;width:4.3in;overflow:hidden}.printcards .planestimate{float:right;font:18pt / 1.26 NotoSans,Helvetica,Arial;font-weight:bold;margin-right:0.3em;margin-top:0.3em}.printcards .content{height:1.8in;overflow:hidden;width:4.3in;color:black;padding-left:4px;padding-right:8px}.printcards .featureBox{border:1px;border-bottom-style:solid;height:21px;width:4.3in;overflow:hidden}.printcards body{background-color:#fff;margin:0;padding:0}.printcards .cb{clear:both}.printcards .artifact{background-color:#fff;border:2px solid #000;float:left;height:3.2in;margin:0.1in 0.1in 0.1in 0.1in;position:relative;overflow:hidden;width:4.3in}.print-page .printcards{width:920px !important;height:100% !important;overflow:hidden !important}.print-page .printcards .header{display:none}@media print{.printcards .pb{page-break-after:always;clear:both}}
    </style>
</head>
<body>
</body>
</html>
